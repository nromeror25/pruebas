<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Medicamentos</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
</head>
<body class="p-4">

  <h2 class="mb-4">📊 Visualizador de Medicamentos</h2>

  <!-- Cargar archivo -->
  <input type="file" id="inputExcel" class="form-control mb-3" />

  <!-- Filtro -->
  <label class="form-label mt-3">Filtrar por ATC</label>
  <select id="filtroATC" class="form-select mb-4">
    <option value="">-- Seleccione --</option>
  </select>

  <!-- Contenedor de tabla -->
  <table id="tablaMedicamentos" class="table table-striped table-bordered mt-3">
    <thead>
      <tr>
        <th>Producto</th>
        <th>CUM</th>
        <th>Titular</th>
        <th>Precio mínimo regulado</th>
        <th>Precio nuevo</th>
        <th>Precio factura 1</th>
        <th>Precio factura 2</th>
        <th>Mensaje</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
<button id="btnExportar" class="btn btn-success mt-3">💾 Exportar a Excel</button>
  <script>
    let datos = [];

    // Leer archivo Excel
    document.getElementById("inputExcel").addEventListener("change", (event) => {
      const file = event.target.files[0];
      const reader = new FileReader();
      reader.onload = (e) => {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: "array" });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        datos = XLSX.utils.sheet_to_json(sheet);
        cargarOpcionesFiltro();
      };
      reader.readAsArrayBuffer(file);
    });

    // Cargar opciones únicas de descripcionatc
    function cargarOpcionesFiltro() {
      const filtro = document.getElementById("filtroATC");
      filtro.innerHTML = `<option value="">-- Seleccione --</option>`;
      const atcs = [...new Set(datos.map(d => d["descripcionatc"]))];
      atcs.forEach(atc => {
        if (atc) {
          const opt = document.createElement("option");
          opt.value = atc;
          opt.textContent = atc;
          filtro.appendChild(opt);
        }
      });
    }

    // Filtrar y mostrar tabla
    document.getElementById("filtroATC").addEventListener("change", (event) => {
      const valor = event.target.value;
      const filtrados = valor ? datos.filter(d => d["descripcionatc"] === valor) : datos;
      mostrarTabla(filtrados);
    });

    // Mostrar tabla
    function mostrarTabla(lista) {
      const tbody = document.querySelector("#tablaMedicamentos tbody");
      tbody.innerHTML = "";

      lista.forEach(d => {
        const fila = document.createElement("tr");

        fila.innerHTML = `
          <td>${d["producto"]}</td>
          <td>${d["CUM"]}</td>
          <td>${d["titular"]}</td>
          <td><input type="number" class="form-control precio-min" placeholder="Ingrese valor mínimo $" /></td>
          <td><input type="number" class="form-control precio-nuevo" placeholder="Ingrese nuevo precio $" /></td>
          <td><input type="number" class="form-control precio-factura1" placeholder="Precio factura 1 $" /></td>
          <td><input type="number" class="form-control precio-factura2" placeholder="Precio factura 2 $" /></td>
          <td class="mensaje"></td>
        `;

        // Capturar inputs
        const inputMin = fila.querySelector(".precio-min");
        const inputNuevo = fila.querySelector(".precio-nuevo");
        const inputFac1 = fila.querySelector(".precio-factura1");
        const inputFac2 = fila.querySelector(".precio-factura2");
        const mensaje = fila.querySelector(".mensaje");

        // Función para actualizar mensaje
        function actualizarMensaje() {
          const minVal = parseFloat(inputMin.value);
          const nuevoVal = parseFloat(inputNuevo.value);
          const fac1Val = parseFloat(inputFac1.value);
          const fac2Val = parseFloat(inputFac2.value);

          let mensajes = [];

          if (!isNaN(nuevoVal) && !isNaN(minVal)) {
            if (nuevoVal < minVal) mensajes.push(`⚠️ Precio nuevo < mínimo`);
          }

          if (!isNaN(fac1Val) && !isNaN(minVal)) {
            if (fac1Val < minVal) mensajes.push(`⚠️ Factura 1 < mínimo`);
            else mensajes.push(`Factura 1 ↑ ${((fac1Val - minVal)/minVal*100).toFixed(2)}% vs mínimo`);
          }

          if (!isNaN(fac2Val) && !isNaN(minVal)) {
            if (fac2Val < minVal) mensajes.push(`⚠️ Factura 2 < mínimo`);
            else mensajes.push(`Factura 2 ↑ ${((fac2Val - minVal)/minVal*100).toFixed(2)}% vs mínimo`);
          }

          if (!isNaN(nuevoVal) && !isNaN(minVal) && nuevoVal >= minVal) mensajes.push("✅ Precio válido");

          mensaje.innerHTML = mensajes.map(m => `<div>${m}</div>`).join("");
        }

        // Eventos en tiempo real
        [inputNuevo, inputFac1, inputFac2, inputMin].forEach(input => {
          input.addEventListener("input", actualizarMensaje);
        });

        tbody.appendChild(fila);
      });
    }

// Exportar tabla a Excel
document.getElementById("btnExportar").addEventListener("click", () => {
  const filas = document.querySelectorAll("#tablaMedicamentos tbody tr");
  const datosExport = [];

  filas.forEach(fila => {
    const producto = fila.children[0].textContent;
    const cum = fila.children[1].textContent;
    const titular = fila.children[2].textContent;
    const precioMin = fila.querySelector(".precio-min").value;
    const precioNuevo = fila.querySelector(".precio-nuevo").value;
    const fac1 = fila.querySelector(".precio-factura1").value;
    const fac2 = fila.querySelector(".precio-factura2").value;
    const mensaje = fila.querySelector(".mensaje").textContent;

    datosExport.push({
      Producto: producto,
      CUM: cum,
      Titular: titular,
      "Precio Mínimo": precioMin,
      "Precio Nuevo": precioNuevo,
      "Factura 1": fac1,
      "Factura 2": fac2,
      Mensaje: mensaje
    });
  });

  const ws = XLSX.utils.json_to_sheet(datosExport);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Medicamentos");
  XLSX.writeFile(wb, "Medicamentos_Export.xlsx");
});

  </script>
</body>
</html>


